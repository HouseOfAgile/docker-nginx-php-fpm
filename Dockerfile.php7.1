FROM phusion/baseimage:0.11

MAINTAINER Meillaud Jean-Christophe (jc@houseofagile.com)

# PHP >7
RUN apt-key adv --recv-keys --keyserver keyserver.ubuntu.com 4F4EA0AAE5267A6C && \
  LC_ALL=en_US.UTF-8 add-apt-repository -y ppa:ondrej/php && \
  apt-get update && apt-get install -y software-properties-common && \
  apt-get update && apt-get install -y \
  nginx \
  software-properties-common \
  git-core \
  php7.1 \
  php7.1-fpm \
  php7.1-mysql \
  php7.1-imagick \
  php7.1-imap \
  php7.1-mcrypt \
  php7.1-curl \
  php7.1-cli \
  php7.1-gd \
  php7.1-pgsql \
  php7.1-sqlite \
  php7.1-common \
  php-pear \
  curl \
  php7.1-json \
  php7.1-intl \
  php7.1-xml \
  php7.1-mbstring \
  php7.1-zip \
  php-apcu \
  python \
  g++ \
  make \
  sudo && \
  chown www-data -R /usr/share/nginx/ && \
  echo "source ~/.bashrc">>/root/.bash_profile && \
  curl -sSL https://raw.github.com/beaudev/bash-profile/master/install-bash-profile.sh|bash && \
  apt-get clean && rm -rf /tmp/* /var/tmp/* && \
  service php7.1-fpm start

RUN useradd -d /home/hoauser -ms /bin/bash -g root -G sudo,www-data -p -p ${DEPL_USER_PASSWORD:-hoauser} hoauser && \
  groupadd hoauser && \
  usermod -aG hoauser hoauser && \
  echo "hoauser ALL=(ALL) NOPASSWD:ALL">/etc/sudoers.d/90-cloud-init-users

# generate a simple index file with phpinfo
ADD nginx-default.conf /etc/nginx/sites-available/default
RUN sed -i 's#%%php_fpm_sock_file%%#/run/php/php7.1-fpm.sock#g' /etc/nginx/sites-available/default && \
  echo "<?php\nphpinfo();">/var/www/html/index.php

# nginx and php-fpm7.1 service
RUN mkdir /etc/service/01_phpfpm /etc/service/02_nginx
RUN echo "#!/usr/bin/env bash\nphp-fpm7.1 -F -c /etc/php/7.1/fpm" > /etc/service/01_phpfpm/run
ADD build/nginx.sh  /etc/service/02_nginx/run
RUN chmod +x /etc/service/01_phpfpm/run /etc/service/02_nginx/run

EXPOSE 80

CMD ["/sbin/my_init"]
